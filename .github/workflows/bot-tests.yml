#name: Bot Tests
#
#on:
#  push:
#    branches: [ main, develop ]
#    paths:
#      - 'bot/**'
#      - 'tests/bot/**'
#      - 'requirements.txt'
#      - '.github/workflows/bot-tests.yml'
#  pull_request:
#    branches: [ main, develop ]
#    paths:
#      - 'bot/**'
#      - 'tests/bot/**'
#      - 'requirements.txt'
#  schedule:
#    # Run nightly at 2 AM UTC
#    - cron: '0 2 * * *'
#  workflow_dispatch:  # Allow manual trigger
#
#jobs:
#  test:
#    name: Run Bot Tests
#    runs-on: ubuntu-latest
#
#    strategy:
#      matrix:
#        python-version: ['3.11', '3.12']
#
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#
#    - name: Set up Python ${{ matrix.python-version }}
#      uses: actions/setup-python@v5
#      with:
#        python-version: ${{ matrix.python-version }}
#        cache: 'pip'
#
#    - name: Install dependencies
#      run: |
#        python -m pip install --upgrade pip
#        pip install -r requirements.txt
#        pip install pytest pytest-asyncio pytest-cov pytest-mock
#
#    - name: Create necessary directories
#      run: |
#        mkdir -p data logs avatars ticket_photos newsletter_photos config
#
#    - name: Run P0 (Critical) tests
#      env:
#        # Обязательные переменные для запуска тестов
#        SECRET_KEY: test_secret_key_for_testing_only
#        SECRET_KEY_JWT: test_jwt_secret_key_for_testing_only
#        ADMIN_LOGIN: test_admin
#        ADMIN_PASSWORD: test_password
#        BOT_TOKEN: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
#        ADMIN_TELEGRAM_ID: 123456789
#        # CAPTCHA (опционально, тесты работают и без него)
#        HCAPTCHA_SECRET_KEY: test_hcaptcha_secret
#        HCAPTCHA_SITE_KEY: test_hcaptcha_site_key
#        # Дополнительные переменные
#        ENVIRONMENT: testing
#        DEBUG: false
#        LOG_LEVEL: ERROR
#        LOG_TO_FILE: false
#        TELEGRAM_LOGGING_ENABLED: false
#      run: |
#        pytest tests/bot/ -m p0 -v --tb=short
#      continue-on-error: false
#
#    - name: Run P1 (High Priority) tests
#      env:
#        # Обязательные переменные для запуска тестов
#        SECRET_KEY: test_secret_key_for_testing_only
#        SECRET_KEY_JWT: test_jwt_secret_key_for_testing_only
#        ADMIN_LOGIN: test_admin
#        ADMIN_PASSWORD: test_password
#        BOT_TOKEN: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
#        ADMIN_TELEGRAM_ID: 123456789
#        # CAPTCHA (опционально, тесты работают и без него)
#        HCAPTCHA_SECRET_KEY: test_hcaptcha_secret
#        HCAPTCHA_SITE_KEY: test_hcaptcha_site_key
#        # Дополнительные переменные
#        ENVIRONMENT: testing
#        DEBUG: false
#        LOG_LEVEL: ERROR
#        LOG_TO_FILE: false
#        TELEGRAM_LOGGING_ENABLED: false
#      run: |
#        pytest tests/bot/ -m p1 -v --tb=short
#      continue-on-error: false
#
#    - name: Run all bot tests with coverage
#      env:
#        # Обязательные переменные для запуска тестов
#        SECRET_KEY: test_secret_key_for_testing_only
#        SECRET_KEY_JWT: test_jwt_secret_key_for_testing_only
#        ADMIN_LOGIN: test_admin
#        ADMIN_PASSWORD: test_password
#        BOT_TOKEN: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
#        ADMIN_TELEGRAM_ID: 123456789
#        # CAPTCHA (опционально, тесты работают и без него)
#        HCAPTCHA_SECRET_KEY: test_hcaptcha_secret
#        HCAPTCHA_SITE_KEY: test_hcaptcha_site_key
#        # Дополнительные переменные
#        ENVIRONMENT: testing
#        DEBUG: false
#        LOG_LEVEL: ERROR
#        LOG_TO_FILE: false
#        TELEGRAM_LOGGING_ENABLED: false
#      run: |
#        pytest tests/bot/ \
#          --cov=bot \
#          --cov-report=term-missing \
#          --cov-report=html \
#          --cov-report=xml \
#          -v
#
#    - name: Check coverage threshold
#      run: |
#        # Fail if coverage < 85%
#        coverage report --fail-under=85
#
#    - name: Upload coverage to Codecov
#      if: matrix.python-version == '3.11'
#      uses: codecov/codecov-action@v4
#      with:
#        file: ./coverage.xml
#        flags: bot-tests
#        name: bot-coverage
#        fail_ci_if_error: false
#
#    - name: Upload coverage HTML report
#      if: matrix.python-version == '3.11'
#      uses: actions/upload-artifact@v4
#      with:
#        name: coverage-report
#        path: htmlcov/
#        retention-days: 30
#
#    - name: Archive test results
#      if: always()
#      uses: actions/upload-artifact@v4
#      with:
#        name: test-results-${{ matrix.python-version }}
#        path: |
#          .pytest_cache/
#          htmlcov/
#        retention-days: 7
#
#  lint:
#    name: Lint Bot Code
#    runs-on: ubuntu-latest
#
#    steps:
#    - name: Checkout code
#      uses: actions/checkout@v4
#
#    - name: Set up Python
#      uses: actions/setup-python@v5
#      with:
#        python-version: '3.11'
#        cache: 'pip'
#
#    - name: Install linting tools
#      run: |
#        python -m pip install --upgrade pip
#        pip install flake8 black isort mypy
#
#    - name: Run flake8
#      run: |
#        # Stop the build if there are Python syntax errors or undefined names
#        flake8 bot/ --count --select=E9,F63,F7,F82 --show-source --statistics
#        # Exit-zero treats all errors as warnings
#        flake8 bot/ --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
#      continue-on-error: true
#
#    - name: Check code formatting with black
#      run: |
#        black --check bot/ tests/bot/
#      continue-on-error: true
#
#    - name: Check import sorting with isort
#      run: |
#        isort --check-only bot/ tests/bot/
#      continue-on-error: true
#
#  notify:
#    name: Notify on Failure
#    runs-on: ubuntu-latest
#    needs: [test, lint]
#    if: failure()
#
#    steps:
#    - name: Send notification
#      run: |
#        echo "Bot tests failed! Check the workflow run for details."
#        # Add your notification mechanism here (Slack, Discord, Telegram, etc.)
name: Bot Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'bot/**'
      - 'tests/bot/**'
      - 'requirements.txt'
      - '.github/workflows/bot-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'bot/**'
      - 'tests/bot/**'
      - 'requirements.txt'
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  test:
    name: Run Bot Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov pytest-mock

    - name: Create necessary directories
      run: |
        mkdir -p data logs avatars ticket_photos newsletter_photos config

    - name: Run P0 (Critical) tests
      env:
        # --- ИСПРАВЛЕНИЕ 1: Добавляем текущую директорию в путь Python ---
        PYTHONPATH: .
        # --- ИСПРАВЛЕНИЕ 2: Заменяем недоступный хост 'web' на localhost ---
        API_BASE_URL: http://127.0.0.1:8000

        # Обязательные переменные
        SECRET_KEY: test_secret_key_for_testing_only
        SECRET_KEY_JWT: test_jwt_secret_key_for_testing_only
        ADMIN_LOGIN: test_admin
        ADMIN_PASSWORD: test_password
        BOT_TOKEN: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
        ADMIN_TELEGRAM_ID: 123456789
        HCAPTCHA_SECRET_KEY: test_hcaptcha_secret
        HCAPTCHA_SITE_KEY: test_hcaptcha_site_key
        ENVIRONMENT: testing
        DEBUG: false
        LOG_LEVEL: ERROR
        LOG_TO_FILE: false
        TELEGRAM_LOGGING_ENABLED: false
      run: |
        pytest tests/bot/ -m p0 -v --tb=short
      continue-on-error: false

    - name: Run P1 (High Priority) tests
      env:
        # Те же исправления здесь
        PYTHONPATH: .
        API_BASE_URL: http://127.0.0.1:8000

        SECRET_KEY: test_secret_key_for_testing_only
        SECRET_KEY_JWT: test_jwt_secret_key_for_testing_only
        ADMIN_LOGIN: test_admin
        ADMIN_PASSWORD: test_password
        BOT_TOKEN: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
        ADMIN_TELEGRAM_ID: 123456789
        HCAPTCHA_SECRET_KEY: test_hcaptcha_secret
        HCAPTCHA_SITE_KEY: test_hcaptcha_site_key
        ENVIRONMENT: testing
        DEBUG: false
        LOG_LEVEL: ERROR
        LOG_TO_FILE: false
        TELEGRAM_LOGGING_ENABLED: false
      run: |
        pytest tests/bot/ -m p1 -v --tb=short
      continue-on-error: false

    - name: Run all bot tests with coverage
      env:
        # И здесь
        PYTHONPATH: .
        API_BASE_URL: http://127.0.0.1:8000

        SECRET_KEY: test_secret_key_for_testing_only
        SECRET_KEY_JWT: test_jwt_secret_key_for_testing_only
        ADMIN_LOGIN: test_admin
        ADMIN_PASSWORD: test_password
        BOT_TOKEN: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz
        ADMIN_TELEGRAM_ID: 123456789
        HCAPTCHA_SECRET_KEY: test_hcaptcha_secret
        HCAPTCHA_SITE_KEY: test_hcaptcha_site_key
        ENVIRONMENT: testing
        DEBUG: false
        LOG_LEVEL: ERROR
        LOG_TO_FILE: false
        TELEGRAM_LOGGING_ENABLED: false
      run: |
        pytest tests/bot/ \
          --cov=bot \
          --cov-report=term-missing \
          --cov-report=html \
          --cov-report=xml \
          -v

    - name: Check coverage threshold
      run: |
        coverage report --fail-under=85

    - name: Upload coverage to Codecov
      if: matrix.python-version == '3.11'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: bot-tests
        name: bot-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }} # Желательно добавить токен, если репозиторий приватный

    - name: Upload coverage HTML report
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 30

    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          .pytest_cache/
          htmlcov/
        retention-days: 7

  lint:
    name: Lint Bot Code
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
    - name: Run flake8
      run: |
        flake8 bot/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 bot/ --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
      continue-on-error: true
    - name: Check code formatting with black
      run: |
        black --check bot/ tests/bot/
      continue-on-error: true
    - name: Check import sorting with isort
      run: |
        isort --check-only bot/ tests/bot/
      continue-on-error: true

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: failure()
    steps:
    - name: Send notification
      run: |
        echo "Bot tests failed! Check the workflow run for details."